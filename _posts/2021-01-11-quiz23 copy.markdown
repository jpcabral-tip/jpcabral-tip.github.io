---
layout: post
title:  "Quiz 3.1: Managed Information Systems Services"
date:   2021-01-11 1:30:00 +0300
image:  quiz-31-banner.png
tags:   [Midterm, Quiz]
---
## Tasks

1. Create a directory named "quiz31" in your student number directory in Quiz 1.3
2. Create a markdown file named "README.md" in the newly created directory with the directory summary.
3. Create a playbook that installs an vsftpd server.
4. Then create a Pull request and put your forked repo in the only question of this quiz (Note answer this quiz as well as create a pull request).

***

## Output

> 1811023/quiz31/ansible.cfg
{% highlight cfg %}
[defaults]

# Basic Configuration
inventory = ./inventory
remote_user = jpcabral-tip
private_key_file = ./private.key

# Priviege Escalation
[privilege_escalation]
become = True
become_method = sudo
become_user = root
become_ask_pass = False
# NOTE: Configure remote host/s to allow remote_user to execute sudo withoout password using sudo visudo. Append `<remote_user> ALL=(ALL) NOPASSWD:ALL`
{% endhighlight %}
<br>

> 1811023/quiz31/inventory
{% highlight cfg %}
[ftpserver]
192.168.254.115
192.168.254.117
{% endhighlight %}
<br>

> 1811023/quiz31/config.yaml
{% highlight yaml %}
name: ftpuser
password: $5$Xz2k7xh2IwRAOtda$X/yQSNPOlQ0Y7t4OdlLCPvrf6vb0DAZEaJfE5tBux.D
user_comment: "FTP User"

ubuntu_vsftpd: u-vsftpd.conf
centos_vsftpd: c-vsftpd.conf

# password is "password"
# generated using `mkpasswd -m sha-512 password`
{% endhighlight %}
<br>

> jpcabral-tip/quiz31/roles/configurevsftpdcentos/tasks/main.yml
{% highlight yaml+jinja %}
---
# tasks file for roles/configurevsftpcentos
- name: Start and Enable vsftpd
  service:
    name: vsftpd
    state: started
    enabled: yes

- name: Create FTP User
  user:
    name: "{{ name }}"
    password: "{{ password }}"
    comment: "{{ user_comment }}"

- name: Create FTP directory
  file:
    path: "/home/{{ name }}/ftp"
    state: directory
    owner: "{{ name }}"
    group: "{{ name }}"
    mode: '0755'

- name: Add FTP user to user_list
  lineinfile:
    path: /etc/vsftpd/user_list
    line: "{{ name }}"
  register: user_list

- name: Copy vsftpd.conf to /etc/vsftpd/vsftpd.conf
  copy:
    src: "{{ centos_vsftpd }}"
    dest: /etc/vsftpd/vsftpd.conf
  register: vsftpd_conf

- name: Restart VSFTPD
  service:
    name: vsftpd
    state: restarted
  when: user_list.changed or vsftpd_conf.changed
{% endhighlight %}
<br>

> jpcabral-tip/quiz31/roles/configurevsftpdubuntu/tasks/main.yml
{% highlight yaml+jinja %}
---
# tasks file for roles/configurevsftpdubuntu
- name: Start and enable VSFTPD
  service:
    name: vsftpd
    state: started
    enabled: yes

- name: Create FTP User
  user:
    name: "{{ name }}"
    password: "{{ password }}"
    comment: "{{ user_comment }}"

- name: Add Deny in /etc/ssh/sshd_config
  lineinfile:
    path: /etc/ssh/sshd_config
    line: "DenyUsers {{ name }}"
  register: sshd_config

- name: Restart SSHD service
  service:
    name: sshd
    state: restarted
  when: sshd_config.changed

- name: Create FTP directory
  file:
    path: "/home/{{ name }}/ftp"
    state: directory
    owner: nobody
    group: nogroup
    mode: '0555'

- name: Create files directory
  file:
    path: "/home/{{ name }}/ftp/files"
    state: directory
    owner: "{{ name }}"
    group: "{{ name }}"

- name: Copy vsftpd.conf to /etc/vsftpd.conf
  copy:
    src: "{{ ubuntu_vsftpd }}"
    dest: /etc/vsftpd.conf
  register: vsftpd_conf

- name: Restart VSFTPD
  service:
    name: vsftpd
    state: restarted
  when: vsftpd_conf.changed
{% endhighlight %}
<br>

> jpcabral-tip/quiz31/roles/installpackagecentos/tasks/main.yml
{% highlight yaml %}
---
# tasks file for roles/installpackagecentos
- name: Install Package using dnf
  yum:
    name: "{{ package }}"
    state: latest
    update_cache: yes
{% endhighlight %}
<br>

> jpcabral-tip/quiz31/roles/installpackageubuntu/tasks/main.yml
{% highlight yaml %}
---
# tasks file for roles/installpackageubuntu
- name: Install package
  apt:
    name: "{{ package }}"
    state: latest
    update_cache: yes
{% endhighlight %}
<br>

> jpcabral-tip/quiz31/roles/stopfirewallcentos/tasks/main.yml
{% highlight yaml %}
---
# tasks file for roles/stopfirewallcentos
- name: Stop FirewallD
  service:
    name: firewalld
    state: stopped
    enabled: no
{% endhighlight %}
<br>

> jpcabral-tip/quiz31/roles/stopfirewallubuntu/tasks/main.yml
{% highlight yaml %}
---
# tasks file for roles/stopfirewallubuntu
- name: Stop Firewall
  service:
    name: ufw
    state: stopped
    enabled: no
{% endhighli

> 1811023/quiz31/playbook.yaml
{% highlight yaml %}
---
  - name: Install VSFTPD
    hosts: ftpserver

    tasks:
    - name: Install VSFTPD using installpackageubuntu role
      include_role:
        name: installpackageubuntu
      vars:
        package: vsftpd
      when: ansible_facts['os_family'] == 'Debian'

    - name: Install HTTPD using installpackagecentos role
      include_role:
        name: installpackagecentos
      vars:
        package: vsftpd
      when: ansible_facts['os_family'] == 'RedHat'


  - name: Stop Firewall
    hosts: ftpserver

    tasks:
    - name: Stop UFW on Ubuntu using stopfirewallubuntu role
      include_role:
        name: stopfirewallubuntu
      when: ansible_facts['os_family'] == 'Debian'

    - name: Stop FirewallD on CentOS using stopfirewallcentos
      include_role:
        name: stopfirewallcentos
      when: ansible_facts['os_family'] == 'RedHat'


  - name: Configure VSFTPD
    hosts: ftpserver

    tasks:
      # REPLACE VALUES OF VARIABLES ON config.yaml
    - name: Include variables from config.yaml
      include_vars:
        file: config.yaml

    - name: Configure VSFTPD on Ubuntu using configurevsftpdubuntu
      include_role:
        name: configurevsftpdubuntu
      when: ansible_facts['os_family'] == 'Debian'

    - name: Configure VSFTPD on CentOS using configurevsftpcentos
      include_role:
        name: configurevsftpcentos
      when: ansible_facts['os_family'] == 'RedHat'
{% endhighlight %}
<br>

> 1811023/quiz23/README.md
{% highlight html %}
# Directory Summary

**Author:** Jose Paulo Cabral

## Prequisites

* Ansible (installed on local machine)
* SSH (installed on both local and remote machine/s)

## Requirements

* SSH private key file for authentication placed on working directory.
* Declared MySQL database user for local and remote hosts. (to be supplied in ``vars/db_config_vars.yaml``
Note: ``private.key`` and ``vars/db_config_vars.yaml`` are placed on ``.gitignore`` and must be supplied before executing the playbook.

## Directory Structure

```
quiz23
	files/
		db.sql
		index.html
		jpcabral-tip.conf
		todo_list.php
	roles/
		copyphp/
			defaults/
				main.yml
			files/
			handlers/
				main.yml
			meta/
				main.yml
			tasks/
				main.yml
			templates/
			tests/
				inventory
				test.yml
			vars/
				main.yml
			README.md
		createdbusermysql/
			defaults/
				main.yml
			files/
			handlers/
				main.yml
			meta/
				main.yml
			tasks/
				main.yml
			templates/
			tests/
				inventory
				test.yml
			vars/
				main.yml
			README.md
		createdbmysql/
			defaults/
				main.yml
			files/
			handlers/
				main.yml
			meta/
				main.yml
			tasks/
				main.yml
			templates/
			tests/
				inventory
				test.yml
			vars/
				main.yml
			README.md
		createvirtualhost/
			defaults/
				main.yml
			files/
			handlers/
				main.yml
			meta/
				main.yml
			tasks/
				main.yml
			templates/
			tests/
				inventory
				test.yml
			vars/
				main.yml
			README.md
		installpackages/
			defaults/
				main.yml
			files/
			handlers/
				main.yml
			meta/
				main.yml
			tasks/
				main.yml
			templates/
			tests/
				inventory
				test.yml
			vars/
				main.yml
			README.md
		pipinstall/
			defaults/
				main.yml
			files/
			handlers/
				main.yml
			meta/
				main.yml
			tasks/
				main.yml
			templates/
			tests/
				inventory
				test.yml
			vars/
				main.yml
			README.md
		startservice/
			defaults/
				main.yml
			files/
			handlers/
				main.yml
			meta/
				main.yml
			tasks/
				main.yml
			templates/
			tests/
				inventory
				test.yml
			vars/
				main.yml
			README.md
	vars/
		db_config_vars.yaml*
ansible.cfg
inventory
playbook.yaml
private.key*
.gitignore
README.md
```

Note: Files marked with asterisk (*) at the end are declared inside ``.gitignore``.

## Content Structure for Files Declared in .gitgnore
* ``private.key``
	The localmachine generated SSH private key (named ``id_rsa`` by default inside ``~/.ssh/``
* ``vars/db_config_vars.yaml``
	```
	db_host: <database IP>
	db_user: <database user>
	db_pass: <database user password>
	```
{% endhighlight %}
<br>

Execute using the following command to run the playbook:
{% highlight bash %}
localhost:~/1811023/quiz31# ansible-playbook playbook.yaml
{% endhighlight %}
<br>

<p>As seen on <a href="https://github.com/jpcabral-tip/sysad2-12021/tree/quiz31">Github</a>.</p>